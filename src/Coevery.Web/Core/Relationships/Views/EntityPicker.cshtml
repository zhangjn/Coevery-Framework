@using Coevery.DisplayManagement.Shapes
@{
    var relatedEntityName = Request.QueryString["relatedEntityName"];
    var fieldName = Request.QueryString["fieldName"];
    if (string.IsNullOrWhiteSpace(relatedEntityName) || string.IsNullOrWhiteSpace(fieldName)) {
        return;
    }
    var gridId = relatedEntityName.ToLower() + fieldName + "Grid";
    var listViewModel = new {
        GridId = gridId,
        GridOptions = new {
            multiselect = false,
            scroll = 1,
            height = 300
        }
    };
    Shape shape = New.Parts_ListViewGrid(listViewModel);
    shape.Metadata.Alternates.Add("Parts_ListViewGrid__" + relatedEntityName);
}
@Display(shape)
@using(Script.Foot()) {
<script type="text/javascript">
    //<![CDATA[
    var grid = $('#@gridId');
    grid.jqGrid('setGridParam', {
        onSelectRow: function() {
            var rowId = grid.jqGrid('getGridParam', 'selrow');
            var result = grid.getRowData(rowId);
            window.parent.jQuery[query("callback")](result);
        }
    });
    
    // get a querystring value
    function query(name, querystring) {
        name = name.toLowerCase();
        var search = querystring || location.search;
        var parts = search.replace("?", "").replace("#", "").split("&");
        for (var i = 0, l = parts.length; i < l; i++) {
            var part = parts[i];
            var eqIndex = part.indexOf("=");
            if (eqIndex !== -1 && part.substr(0, eqIndex).toLowerCase() === name) {
                return part.substr(eqIndex + 1);
            }
        }
        return [];
    }
//]]>
</script>
}