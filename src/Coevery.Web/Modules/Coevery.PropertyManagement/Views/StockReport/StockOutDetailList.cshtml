@using Coevery.PropertyManagement.ViewModels
@using Coevery.Utility.Extensions
@Html.AntiForgeryToken()
@{
    Layout.Title = "领用出库明细";
    var gridId = "stockoutdetail-list";

    Style.Require("jqGrid");
    Style.Require("jqGridCustom");
    Script.Require("jqGrid");
    Script.Require("jqGrid_i18n");

    var gridPagerId = gridId + "Pager";
    var materialViewModel = new EntitySelectorViewModel
    {
        ClientId = "Filter_MaterialId",
        ClientName = "Filter.MaterialId",
        DisplayFieldName = "Name",
        DropdownUrl = Url.Action("MaterialDropdown", "StockReport"),
        Label = "物品名称",
        PopupWindowCaption = "请选择物品名称",
        RelatedEntityName = "Material",
        RequiredMsg = "请选择物品名称!",
        Required = true
    };
}

<div id="filters" class="form-inline">
    <div class="searchbox">
        <label class="lb-60" for="Filter_BeginDate">@T("开始日期:")</label>
        <div class="input-prepend date-text" data-co-datetime-picker="date">
            <span class="add-on">
                <i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"></i>
            </span>
            @Html.TextBox("Filter.BeginDate", null, new {@class = "date"})
        </div>
    </div>
    <div class="searchbox">
        <label class="lb-60" for="Filter_EndDate">@T("结束日期:")</label>
        <div class="input-prepend date-text" data-co-datetime-picker="date">
            <span class="add-on">
                <i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"></i>
            </span>
            @Html.TextBox("Filter.EndDate", null, new {@class = "date"})
        </div>
    </div>

    <div class="row-fluid">
        <div class="searchbox span4 ">
            @Display.Partial(TemplateName: "EntitySelector", Model: materialViewModel)
        </div>
    </div>

    <button type="submit" id="btnStockOutFilter" class="btn btn-small"><i class="icos-looking-glass"></i>&nbsp;查找</button>
    @*<button id="btnRefresh" class="btn btn-small" type="button"><i class="icon-refresh"></i>&nbsp;@T("刷新")</button>*@
    <button id="btnExport" class="btn btn-small btnExport" name="reset">导出Excel</button>    
   
</div>

<div class="row-fluid">
    <table id="@gridId"></table>
    <section id="@gridPagerId"></section>
</div>



@using (Script.Foot())
{
    <script>

        $(function() {

            var grid = $('#@gridId');
            $('#btnRefresh').click(function() {
                grid.trigger('reloadGrid');
            });

            $('#btnStockOutFilter').click(function () {
                debugger;
                var postData = grid.jqGrid('getGridParam', 'postData');
                $('#filters :input').serializeArray().map(function (x) { postData[x.name] = x.value; });
                grid.trigger("reloadGrid");
            });

            $('#btnReset').click(function() {
                $('#filters :input').val('');
                $('#btnStockOutFilter').trigger('click');
            });

            $.extend(jQuery.jgrid.defaults, {
                prmNames: {
                    page: 'page',
                    rows: 'pageSize',
                    sort: 'sortBy',
                    order: 'sortOrder'
                },
                datatype: 'json',
                mtype: 'POST',
                postData: {
                    __RequestVerificationToken: function() {
                        var magicToken = $("input[name=__RequestVerificationToken]").first();
                        if (magicToken.length == 0) {
                            return null;
                        } // no sense in continuing if form POSTS will fail
                        return magicToken.val();
                    }
                },
                viewrecords: true,
                height: '100%',
                pagerpos: 'right',
                recordpos: 'left',
                sortable: true,
                headertitles: true,
                autowidth: true,
                jsonReader: {
                    page: 'page',
                    total: 'totalPages',
                    records: 'totalRecords',
                    repeatitems: false
                }
            });
            var gridColModel = [
                { name: 'Id', hidden: true, key: true },
                { name: 'VoucherNo', label: '出库单号' },
                { name: 'DepartmentName', label: '领用部门' },
                { name: 'MaterialSerialNo', label: '物品编号' },
                { name: 'MaterialName', label: '物品名称' },
                { name: 'MaterialUnit', label: '单位' },
                { name: 'CostPrice', label: '成本价', formatter: "currency", formatoptions: { decimalPlaces: 2, defaultValue: '' } },
                { name: 'Number', label: '数量' },
                { name: 'Amount', label: '金额', formatter: "currency", formatoptions: { decimalPlaces: 2, defaultValue: '' } },
                { name: 'Date', label: '操作日期' }
            ];
            var gridOptions = {
                url: '@Url.Action("StockOutDetailList", "StockReport", new {area = "Coevery.PropertyManagement"})',
                colModel: gridColModel,
                pager: '#@gridPagerId',
                rowNum: 50,
                rowList: [50, 100, 150],
                sortname: '',
                sortorder: 'Asc',
                multiselect: false,
            };

            grid.jqGrid(gridOptions);

            $('#btnExport').click(function() {
                var fakeFormHtmlFragment = "<form style='display: none;' method='POST' action='@Url.Action("StockOutDetailExportExcel")'></form>";
                var fakeForm = $(fakeFormHtmlFragment);
                $('#filters :input').serializeArray().map(function(x) {
                    fakeForm.append("<input type='hidden' name='" + x.name + "' value='" + x.value + "'>");
                });
                fakeForm.append("<input type='hidden' name='gridColumns' value='" + JSON.stringify(gridColModel) + "'>");
                fakeForm.append($("input[name=__RequestVerificationToken]").clone());
                $("body").append(fakeForm);
                fakeForm.submit();
            });
        });
    </script>
}