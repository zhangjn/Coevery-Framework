

@{
    Style.Require("jqGrid");
    Style.Require("jqGridCustom");
    Script.Require("jqGrid");
	Script.Require("jqGrid_i18n");
    Script.Require("moment");

    var gridPagerId = Model.GridId + "Pager";
}
<style type="text/css">
    #houseGrid input[type="checkbox"] {
        width: 20px;
        height: 25px;
        padding: 0 5px 0 0;
        display: block;
        clear: left;
        float: left;
    }
 
</style>
<div class="row-fluid" style="margin-top: 20px">
    <form action="@Url.Action("Import", "House")" method="post" enctype="multipart/form-data">
        <input type="file" name="importFile" style="position: absolute; z-index: 10; opacity: 0; height: 26px;" />
        <button id="btnImportHouseMeter" type="button" style="z-index: 0" class="btn btn-small btn-primary">@T("批量导入")</button>
        <a href='@Url.Action("DownLoadTemplate", "House", new { area = "Coevery.PropertyManagement" })'>下载导入数据模板</a>
    </form>
</div>
<div class="row-fluid">
    <table id="@Model.GridId"></table>
    <section id="@gridPagerId"></section>
    <p id="summary-line"></p>
</div>
@Html.AntiForgeryToken()

@using (Script.Foot()) {
    <script type="text/javascript">
    moment.lang('@WorkContext.CurrentCulture.ToLower()');
    function utcDateFormatter(cellvalue, options, rowObject) {
        if (cellvalue) {
            return moment(cellvalue).format('l');
        } else {
            return '';
        }
    }

    function utcDateTimeFormatter(cellvalue, options, rowObject) {
        if (cellvalue) {
            return moment(cellvalue).format('l LT');
        } else {
            return '';
        }
    }

    $.extend(jQuery.jgrid.defaults, {
        prmNames: {
            page: 'page',
            rows: 'pageSize',
            sort: 'sortBy',
            order: 'sortOrder'
        },
        datatype: 'json',
        mtype: 'POST',
        postData: {
            __RequestVerificationToken: function () {
                var magicToken = $("input[name=__RequestVerificationToken]").first();
                if (magicToken.length == 0) {
                    return null;
                } // no sense in continuing if form POSTS will fail
                return magicToken.val();
            }
        },
        viewrecords: true,
        height: '100%',
        pagerpos: 'right',
        recordpos: 'left',
        sortable: true,
        headertitles: true,
        multiselect: true,
        multiboxonly: true,
        autowidth: true,
        jsonReader: {
            page: 'page',
            total: 'totalPages',
            records: 'totalRecords',
            repeatitems: false
        }
    });

    var gridOptions = {
        url: '@Url.Action("List","House",  new { area = "Coevery.PropertyManagement" })',
        colModel: [
            { "name": "Apartment_Name", "label": "楼盘", "sortable": false }, { "name": "Apartment", "index": "Apartment", "label": "楼盘", "sortable": false, "hidden": true },
            { "name": "Building_Name", "label": "楼宇", "sortable": false }, { "name": "Building", "index": "Building", "label": "楼宇", "sortable": false, "hidden": true },
            { "name": "HouseNumber", "index": "HouseNumber", "label": "房号", "sortable": true },
            { "name": "InsideArea", "index": "InsideArea", "label": "套内面积", "sortable": true, "formatter": "number" },
            { "name": "BuildingArea", "index": "BuildingArea", "label": "建筑面积", "sortable": true, "formatter": "number" },
            { "name": "PoolArea", "index": "PoolArea", "label": "公摊面积", "sortable": true, "formatter": "number" },
            { "name": "HouseStatus", "index": "HouseStatus", "label": "房屋状态", "sortable": false },
            { "name": "OwnerName", "label": "业主", "sortable": false }, { "name": "Owner", "index": "Owner", "label": "业主", "sortable": false, "hidden": true },
            { "name": "Contact", "index": "Contact", "label": "联系电话", "sortable": true },
            { "name": "ChargeItemNames", "index": "ChargeItemNames", "label": "收费项目", "sortable": true },
            { "name": "MeterItemNames", "index": "MeterItemNames", "label": "房间仪表", "sortable": true },
            { "name": "OfficerName", "index": "OfficerName", "label": "专管员", "sortable": true },
            { "name": "Id", "hidden": true, "key": true }],
        pager: '#@gridPagerId',
        rowNum: 50,
        rowList: [50, 100, 150],
        sortname: 'HouseNumber',
        sortorder: 'Asc',
        loadComplete: function (data) {
            var summaryLine = "房间数合计:" + data.totalRecords + "&nbsp;&nbsp;建筑面积合计:" + data.totalBuildingArea.toFixed(2) + "&nbsp;&nbsp;套内面积合计:" + data.totalInsideArea.toFixed(2)
              + "&nbsp;&nbsp;公摊面积合计:" + data.totalPoolArea.toFixed(2);
            $("#summary-line").html(summaryLine);
        }
    };

    @if (Model.GridOptions != null)
    {
        var json = Html.Raw(Json.Encode(Model.GridOptions));
        WriteLiteral("		$.extend(gridOptions, " + json + ");");
    }

    $('#@Model.GridId').jqGrid(gridOptions);
    var importButtons = $('input[name="importFile"]');

    importButtons.each(function () {
        var $this = $(this);
        $this.width($this.next().outerWidth());
    });

    importButtons.change(function () {
        var $this = $(this),
            val = $this.val();
        if (!val) {
            return;
        }
        if (!/\.(xls|xlsx)$/.test(val)) {
            $.pnotify({
                title: '错误',
                type: 'Error',
                text: '只支持上传Excel文件！'
            });
            return;
        }
        $this.parent().submit();
        $this.val(null);
    });
</script>
}
