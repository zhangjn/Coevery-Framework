@model Coevery.PropertyManagement.ViewModels.ServiceVoucherCreateViewModel
@using Coevery.PropertyManagement.ViewModels
@using Coevery.Utility.Extensions
@{
    Layout.Title = "维修领料";
    Style.Require("jqGrid");
    Style.Require("jqGridCustom");
    Script.Require("jqGrid");
    Script.Require("jqGrid_i18n");
    var servicePersonViewModel = new EntitySelectorViewModel
    {
        ClientId = "ServicePersonId",
        DisplayFieldName = "Name",
        DropdownUrl = Url.Action("ServicePersonDropdown", "Service"),
        Label = "维修人员",
        PopupWindowCaption = "请选择维修人员",
        RelatedEntityName = "User",
        RequiredMsg = "请选择维修人员!",
        Required = true
    };
  
}

<div class="row-fluid edit-mode">

    <fieldset>
        <legend>@T("基本信息")</legend>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">维修单号</label>
                <div class="controls">
                    @Html.TextBox("VoucherNo", @Model.VoucherNo, new
                        {
                            @readonly = true,
                            @class = "span12"
                        })
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">单据日期</label>
                <div class="controls">
                    <div class="input-prepend date-text span12" data-co-datetime-picker="date">
                        <span class="add-on">
                            <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                        </span>
                        @Html.TextBox("BeginDate", DateTime.Now.ToString("MM/dd/yyyy"), new Dictionary<string, object>
                        {
                            {"required", ""},
                            {"class", "date"},
                            {"data-msg-required", "开始时间！"}
                        })
                    </div>
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">维修地址</label>
                <div class="controls">
                    @Html.TextBox("Address", @Model.Address, new
                        {
                            @readonly = true,
                            @class = "span12"
                        })
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">业主</label>
                <div class="controls">
                    @Html.TextBox("OwnerName", @Model.OwnerName, new
                        {
                            @readonly = true,
                            @class = "span12"
                        })
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">电话</label>
                <div class="controls">
                    @Html.TextBox("Mobile", @Model.Mobile, new
                        {
                            @readonly = true,
                            @class = "span12"
                        })
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">故障描述</label>
                <div class="controls">
                    @Html.TextBox("FaultDescription", @Model.FaultDescription, new
                        {
                            @readonly = true,
                            @class = "span12"
                        })
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">接收时间</label>
                <div class="controls">
                    @Html.TextBox("ReceivedDate", @Model.ReceivedDate, new
                        {
                            @readonly = true,
                            @class = "span12"
                        })
                </div>
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                @Display.Partial(TemplateName: "EntitySelector", Model: servicePersonViewModel)
            </div>
        </div>
        <div class="data-row clearfix">
            <div class="span12 control-group">
                <label class="title control-label">详细材料列表</label>
                <div class="control controls">
                    <div class="btn-toolbar">
                        <button id="btnAddMaterial" class="btn btn-small"><i class="icon-plus"></i>&nbsp;添加</button>
                        <button id="btnDeleteMaterial" class="btn btn-small"><i class="icon-trash"></i>&nbsp;删除</button>
                    </div>
                    <table id="itemGrid"></table>
                </div>
            </div>
        </div>
    </fieldset>


    <div class="data-row clearfix">
        <div class="control controls">
            <button id="btnSubmit" class="btn btn-small btn-primary">@T("保存")</button>
            @{
                var returnUrl = Request.QueryString["returnUrl"];
            }
            @if (!String.IsNullOrWhiteSpace(returnUrl) && Request.IsLocalUrl(returnUrl))
            {
                <a class="btn btn-small" href="@returnUrl">@T("取消")</a>
            }
        </div>
    </div>

</div>

<div id="material-modal" class="modal large" style="visibility: hidden;" tabindex="-1">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>选择材料</h3>
    </div>
    <div class="modal-body">
        <table id="material-grid"></table>
        <section id="material-pager"></section>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-ok">@T("OK")</button>
        <button type="button" data-dismiss="modal" class="btn">@T("Cancel")</button>
    </div>
</div>

<div id="preview-modal" class="modal hide large" tabindex="-1">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>预览</h3>
    </div>
    <div class="modal-body" id="print-content">
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-ok">@T("OK")</button>
        <button type="button" data-dismiss="modal" class="btn">@T("Cancel")</button>
    </div>
</div>
<script id="preview-template" type="text/x-handlebars-template">
    @Display.Partial(TemplateName: "Service/VoucherPreviewTemplate")
</script>


@Html.AntiForgeryToken()

@using (Script.Foot())
{
    <script type="text/javascript">
        $(function() {
            var grid = $('#itemGrid'),
                material = $('#material'),
                materialGridModal = $('#material-modal'),
                materialGrid = $('#material-grid'),
                btnAddMaterial = $('#btnAddMaterial'),
                previewModal = $('#preview-modal'),
                btnDelete = $('#btnDeleteMaterial'),
                btnSubmit = $('#btnSubmit'),
                index = 0,
                gridOptions = {
                    colModel: [
                        { name: 'MaterialId', hidden: true },
                        { name: 'SerialNo', label: '材料编号', sortable: false, resizable: false },
                        { name: 'Name', label: '材料名称', sortable: false, resizable: false },
                        { name: 'Brand', label: '品牌', sortable: false, resizable: false },
                        { name: 'Model', label: '规格型号', sortable: false, resizable: false },
                        { name: 'Unit', label: '单位', sortable: false, resizable: false },
                        { name: 'CostPrice', label: '成本价', sortable: false, formatter: "currency", formatoptions: { decimalPlaces: 2, defaultValue: '' } },
                        { name: 'Number', label: '数量', sortable: false, editable: true, resizable: false }
                    ],
                    datatype: 'local',
                    height: '100%',
                    multiselect: true,
                    multiboxonly: true,
                    autowidth: true,
                    rowNum: 10000,
                    'cellEdit': true,
                    'cellsubmit': 'clientArray',
                    editurl: 'clientArray',
                    loadComplete: function() {
                        var $this = $(this), ids = $this.jqGrid('getDataIDs'), i, l = ids.length;
                        for (i = 0; i < l; i++) {
                            $this.jqGrid('editRow', ids[i], true);
                        }
                    }
                };

            grid.jqGrid(gridOptions);
            grid.setGridParam({ onSelectRow: updateButtonStatus, onSelectAll: updateButtonStatus });
            updateButtonStatus();

            btnDelete.click(function() {
                var selectedIds = grid.getGridParam('selarrrow');
                if (selectedIds.length <= 0) {
                    return;
                }
                while (selectedIds.length) {
                    grid.delRowData(selectedIds[0]);
                }
                updateButtonStatus();
            });

            btnSubmit.click(function(e) {
                e.preventDefault();
                if ($('#ServicePersonId').select2('val') == '') {
                    $.pnotify({ title: '提示', text: '请选择维修人员！', type: 'Error' });
                    return;
                }
                var ids = grid.jqGrid('getDataIDs');
                for (var id = 0; id < ids.length; id++) {
                    grid.saveRow(ids[id], true, 'clientArray');
                }
                var data = grid.getRowData();
                for (var i in data) {
                    if (isNaN(data[i].Number)) {
                        $.pnotify({ title: '提示', text: '领料数量只能输入数字！', type: 'Error' });
                        grid.trigger("reloadGrid");
                        return;
                    }
                    if (parseFloat(data[i].Number) <= 0 || data[i].Number == '') {
                        $.pnotify({ title: '提示', text: '请添加：' + data[i].Name + '的领料数量！', type: 'Error' });
                        grid.trigger("reloadGrid");
                        return;
                    }
                }
                //if (!data.length) {//只有人工情况
                //    serviceVoucherCreateWithoutMateria();
                //    return ;
                //}

                var source = $("#preview-template").html();
                var template = Handlebars.compile(source);
                var model = {
                    List: $.map(data, function(item, i) {
                        return {
                            Id: i + 1,
                            Material_SerialNo: item.SerialNo,
                            Material_Name: item.Name,
                            Material_Brand: item.Brand,
                            Material_Model: item.Model,
                            Material_Unit: item.Unit,
                            Number: item.Number,
                            CostPrice: item.CostPrice,
                            Total: item.CostPrice * item.Number
                        };
                    })
                };
                var totalMoney = 0;
                for (var i in model.List) {
                    totalMoney = model.List[i].Total + totalMoney;
                }

                $.extend(model, {
                    TotalMoney: parseFloat(totalMoney),
                    VoucherNo: $('#VoucherNo').val(),
                    ReceivedDate: $('#ReceivedDate').val(),
                    Address: $('#Address').val(),
                    Mobile: $('#Mobile').val(),
                    OwnerName: '@Model.OwnerName',
                    FaultDescription: '@Model.FaultDescription',
                    ServicePersonName: $('#ServicePersonId').select2('data').text
                });

                $('#preview-modal > .modal-body').html(template(model));

                previewModal.modal('show');
            });

            function serviceVoucherCreateWithoutMateria() {
                 var   magicToken = $("input[name=__RequestVerificationToken]:first");
                $.ajax({
                    type: 'POST',
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    url: '@Url.Action("ServiceVoucherCreate", "Service")',
                    data: JSON.stringify({
                        model: {
                            id: '@Model.id',
                            ServicePersonId: $('#ServicePersonId').val()
                        },
                        __RequestVerificationToken: magicToken.val()
                    }),
                    success: function (response) {
                        if (response.Result) {
                            window.location.href = response.Url;
                        } 
                    },
                    error: function () {
                        $.pnotify({ title: '提示', text: '提交失败，请重试！', type: 'Error' });
                    }
                });
            }


            previewModal.find('.btn-ok').click(function() {
                var data = grid.getRowData(),
                    magicToken = $("input[name=__RequestVerificationToken]:first");

                $.ajax({
                    type: 'POST',
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    url: '@Url.Action("ServiceVoucherCreate", "Service")',
                    data: JSON.stringify({
                        model: {
                            id: '@Model.id',
                            ServicePersonId: $('#ServicePersonId').val(),
                            InventoryDetailEntities: data
                        },
                        __RequestVerificationToken: magicToken.val()
                    }),
                    success: function (response) {
                        if (response.Result) {
                            window.location.href = response.Url;
                        } else {
                            $.pnotify({ title: '提示', text: '超过库存数量！', type: 'Error' });
                            grid.trigger("reloadGrid");
                        }
                    },
                    error: function () {
                        $.pnotify({ title: '提示', text: '提交失败，请重试！', type: 'Error' });
                    }
                });
                previewModal.modal('hide');
            });

            function updateButtonStatus() {
                var selectedRowIds = grid.getGridParam('selarrrow');
                btnDelete.toggleClass('disabled', selectedRowIds.length <= 0);
                //btnSubmit.toggleClass('disabled', !grid.getRowData().length);
            }


            var materialGridOptions = {
                url: '@Url.Action("StockOutMaterialList", "Material", new { area = "Coevery.PropertyManagement" })',
                colModel: [{ "name": "SerialNo", "index": "SerialNo", "label": "材料编号", "sortable": true },
                       { "name": "Name", "index": "Name", "label": "材料名称", "sortable": true },
                       { "name": "Brand", "index": "Brand", "label": "品牌", "sortable": true },
                       { "name": "Model", "index": "Model", "label": "规格型号", "sortable": true },
                        { "name": "Unit", "index": "Unit", "label": "单位", "sortable": true },
                        { "name": "Remark", "index": "Remark", "label": "备注", "sortable": true },
                        { "name": "StockPrice", "index": "StockPrice", "label": "出库价", "sortable": true },
                        { "name": "Id", "hidden": true, "key": true }],
                pager: '#material-pager',
                rowNum: 50,
                sortname: '',
                sortorder: '',
                multiselect: false,
                scroll: 1,
                height: 300,
                autowidth: true,
                prmNames: {
                    page: 'page',
                    rows: 'pageSize',
                    sort: 'sortBy',
                    order: 'sortOrder'
                },
                datatype: 'json',
                mtype: 'POST',
                postData: {
                    __RequestVerificationToken: function () {
                        var magicToken = $("input[name=__RequestVerificationToken]").first();
                        if (magicToken.length == 0) {
                            return null;
                        } // no sense in continuing if form POSTS will fail
                        return magicToken.val();
                    }
                },
                viewrecords: true,
                recordpos: 'left',
                sortable: true,
                headertitles: true,
                jsonReader: {
                    page: 'page',
                    total: 'totalPages',
                    records: 'totalRecords',
                    repeatitems: false
                }
            };

            materialGrid.jqGrid(materialGridOptions);
            materialGridModal.addClass('hide');
            materialGridModal.css('visibility', 'visible');

            btnAddMaterial.click(function (e) {
                e.preventDefault();
                materialGridModal.modal('show');
                materialGrid.trigger("reloadGrid");
            });

            materialGridModal.find('.btn-ok').click(function () {
                var rowId = materialGrid.jqGrid('getGridParam', 'selrow');
                if (rowId) {
                    var result = materialGrid.getRowData(rowId);
                    material.data('result', result);
                 var data = grid.getRowData(),
                 isExist = false;
                    for (var i = 0; i < data.length; i++) {
                        var row = data[i];
                        if (row.Name == result.Name && row.Brand == result.Brand
                            && row.Model == result.Model && row.Unit == result.Unit
                           ) {
                            isExist = true;
                            break;
                        }
                    }

                    if (!isExist) {
                        index++;
                        var newMaterial = {
                            MaterialId: result.Id,
                            SerialNo: result.SerialNo,
                            Name: result.Name,
                            Brand: result.Brand,
                            Model: result.Model,
                            Unit: result.Unit,
                            CostPrice: result.StockPrice
                        };
                        grid.addRowData(index, newMaterial);
                        grid.trigger("reloadGrid");
                    }

                    updateButtonStatus();
                }
                materialGridModal.modal('hide');
            });

        });
    </script>
}