@using Coevery.PropertyManagement.ViewModels
@using Coevery.Utility.Extensions
@Html.AntiForgeryToken()
@{
    Layout.Title = "客户预付款列表";
    var gridId = "advancePayment-list";

    Style.Require("jqGrid");
    Style.Require("jqGridCustom");
    Script.Require("jqGrid");
    Script.Require("jqGrid_i18n");

    var gridPagerId = gridId + "Pager";
   
}

<div id="page-actions" class="clearfix">
    <div class="btn-toolbar pull-left">
        <a class="btn btn-small btn-success" href="@Url.Action("CustomerAdvancePayment", new { returnUrl = ViewContext.RequestContext.HttpContext.Request.ToUrlString() })"><i class="icon-plus"></i>&nbsp;@T("Add")</a>
        <button id="btnView" class="btn btn-small btn-primary hide" type="button"><i class="icon-edit"></i>&nbsp;@T("查看")</button>
        <button id="btnRefresh" class="btn btn-small" type="button"><i class="icon-refresh"></i>&nbsp;@T("刷新")</button>
    </div>
</div>

<div class="row-fluid">
    <table id="@gridId"></table>
    <section id="@gridPagerId"></section>
</div>



@using (Script.Foot())
{
    <script>

        $(function() {

            var grid = $('#@gridId');

            $('#btnView').click(function() {
                var selectedRowIds = grid.jqGrid('getGridParam', 'selarrrow');
                if (selectedRowIds.length == 0) return;
                window.location.href = '@Url.Action("CustomerAdvancePaymentPreview")/' + selectedRowIds[0] + '?returnUrl=@ViewContext.RequestContext.HttpContext.Request.ToUrlString()';
            });


            $('#btnRefresh').click(function() {
                grid.trigger('reloadGrid');
            });

          

            $.extend(jQuery.jgrid.defaults, {
                prmNames: {
                    page: 'page',
                    rows: 'pageSize',
                    sort: 'sortBy',
                    order: 'sortOrder'
                },
                datatype: 'json',
                mtype: 'POST',
                postData: {
                    __RequestVerificationToken: function() {
                        var magicToken = $("input[name=__RequestVerificationToken]").first();
                        if (magicToken.length == 0) {
                            return null;
                        } // no sense in continuing if form POSTS will fail
                        return magicToken.val();
                    }
                },
                viewrecords: true,
                height: '100%',
                pagerpos: 'right',
                recordpos: 'left',
                sortable: true,
                headertitles: true,
                autowidth: true,
                jsonReader: {
                    page: 'page',
                    total: 'totalPages',
                    records: 'totalRecords',
                    repeatitems: false
                }
            });

            var gridOptions = {
                url: '@Url.Action("List", "AdvancePayment", new {area = "Coevery.PropertyManagement"})',
                colModel: [
                    { name: 'Id', hidden: true, key: true },
                    { name: 'CustomerName', label: '客户姓名' },
                    { name: 'Paid', label: '付款金额' },
                    { name: 'PaidDate', label: '付款日期' },
                    { name: 'OperatorName', label: '操作员' }
                ],
                pager: '#@gridPagerId',
                rowNum: 50,
                rowList: [50, 100, 150],
                sortname: '',
                sortorder: 'Asc',
                multiselect: true,
            };

            grid.jqGrid(gridOptions);

            function updateButtonStatus() {
                var selectedRowIds = grid.jqGrid('getGridParam', 'selarrrow');
                $("#btnView").toggle(selectedRowIds.length == 1);
            }

            grid.jqGrid('setGridParam', {
                onSelectRow: function() {
                    updateButtonStatus();
                }
            });
            grid.jqGrid('setGridParam', { gridComplete: function () { updateButtonStatus(); } });
            
        });
    </script>
}